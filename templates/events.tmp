<h1 id="upcoming">Upcoming Events</h1>
<div class="events"></div>
<script>
    // Get all events from a Google Sheet
    var url = 'https://sheets.googleapis.com/v4/spreadsheets/1Zd0MEe68i77bECHKtAqRTI8VGcmaJVNlDwLhySYgsWw/values/Respostes%20al%20formulari%201?key=AIzaSyBnrpDkEddq-GePUKlJXS_fV82ggNNmksg',
        request = new XMLHttpRequest(),
        eventsDiv = document.querySelector('.events');

    request.open('GET', url);

    request.onreadystatechange = function () {
        if (this.readyState === 4) {
            if (this.status === 200 || this.status === 0) {
                try {
                    var rows = JSON.parse(this.response).values;
                    rows.map(function (row) {
                        // turn dates into actual dates
                        var splitCell = row[5].split('/'); // date as DD/MM/YYYY
                        row[0] = new Date(); // reuse unused row[0]
                        row[0].setDate(splitCell[0]); // date means DOTM
                        row[0].setMonth(splitCell[1] - 1); // months are 0-based
                        row[0].setYear(splitCell[2]);
                    });
                    rows.splice(1).filter(
                        function (row) {
                            return new Date() <= row[0];
                        }
                    ).sort(
                        function (a, b) {
                            return a[0] > b[0];
                        }).forEach(function (row) {
                            if (row[9] === 'TRUE') { // event is approved

                                newEvent(
                                    row[1], // title
                                    row[2], // organizer
                                    row[3], // location
                                    row[4], // URL
                                    row[5], // date
                                    row[6], // time
                                    row[7]  // description
                                );
                            }
                        }
                    );
                } catch (err) {
                    // no events
                }
            }
        }
    };

    request.send(null);
    
    function newEvent(
        title,
        organizer,
        eventLocation,
        url,
        date,
        time,
        description
    ) {
        var eventDiv = document.createElement('div'),
            titleH2 = document.createElement('h2'),
            organizerSpan = document.createElement('span'),
            locationSpan = document.createElement('span'),
            urlAnchor = document.createElement('a'),
            dateSpan = document.createElement('span'),
            descriptionSpan = document.createElement('span');

        eventDiv.classList.add('event');

        titleH2.innerHTML = title;
        titleH2.classList.add('title');
        eventDiv.append(titleH2);

        if (organizer) {
            organizerSpan.innerHTML = '<strong>Organizer:</strong> ' + organizer;
            organizerSpan.classList.add('organizer');
            eventDiv.append(organizerSpan);
        }

        locationSpan.innerHTML = '<strong>Location:</strong> ' + eventLocation;
        locationSpan.classList.add('location');
        eventDiv.append(locationSpan);

        dateSpan.innerHTML = '<strong>Date:</strong> ' + date;
        dateSpan.classList.add('date');
        eventDiv.append(dateSpan);

        if (time) {
            dateSpan.innerHTML += ', at ' + time;
        }

        if (description) {
            descriptionSpan.innerHTML =
                '<strong>Description:</strong><span>' + description + '</span>';
            descriptionSpan.classList.add('description');
            eventDiv.append(descriptionSpan);
            if (url) {
                urlAnchor.href = url;
                urlAnchor.innerHTML = 'more information';
                urlAnchor.classList.add('url');
                descriptionSpan.append(urlAnchor);
            }
        }

        eventsDiv.append(eventDiv);
    };

</script>
